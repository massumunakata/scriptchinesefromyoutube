# インストール（Google Colab用）
!pip install -U yt-dlp
!pip install -U git+https://github.com/openai/whisper.git
!apt install ffmpeg -y

import yt_dlp
import os
import whisper

model = whisper.load_model("small")

query = ""  #@param {type:"string"}
youtube_urls_input = query
youtube_urls = youtube_urls_input.strip().split()

for i, url in enumerate(youtube_urls):
    print(f"\n🎬 処理中の動画 {i+1}: {url}")

    # ファイル名を動画ごとにユニークに
    original_mp3 = f"downloaded_{i}.mp3"
    fast_mp3 = f"fast_{i}.mp3"

    # ダウンロード設定
    ydl_opts = {
        'format': 'bestaudio/best',
        'outtmpl': f'downloaded_{i}.%(ext)s',
        'postprocessors': [{
            'key': 'FFmpegExtractAudio',
            'preferredcodec': 'mp3',
            'preferredquality': '192',
        }],
        'quiet': True
    }

    # 音声ダウンロード
    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        try:
            ydl.download([url])
        except Exception as e:
            print(f"⚠️ ダウンロード失敗: {e}")
            continue

    # 🔁 1.5倍速に変換（ffmpeg）
    try:
        os.system(f"ffmpeg -i {original_mp3} -filter:a 'atempo=1.5' -vn {fast_mp3}")
    except Exception as e:
        print(f"⚠️ 速度変換失敗: {e}")
        continue

    # Whisperで文字起こし（中国語指定）
    try:
        result = model.transcribe(fast_mp3, language="zh")
        print("📝 認識されたテキスト:")
        print(result["text"])
    except Exception as e:
        print(f"⚠️ 文字起こし失敗: {e}")
